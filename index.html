<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Employee Comparison</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
        integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
</head>

<body>
    <h1>Excel Comparison</h1>
    <input type="file" id="fileInput" accept=".xlsx">

    <script>
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const sheetNames = workbook.SheetNames;
                    const sheet1Name = sheetNames[0];
                    const sheet2Name = sheetNames[1];

                    const sheet1 = workbook.Sheets[sheet1Name];
                    const sheet2 = workbook.Sheets[sheet2Name];

                    const sheet1Data = XLSX.utils.sheet_to_json(sheet1, { header: 1 });
                    const sheet2Data = XLSX.utils.sheet_to_json(sheet2, { header: 1 });

                    // Call the function that contains your comparison logic
                    compareWorksheets(file.name, sheet1Name, sheet2Name, sheet1Data, sheet2Data);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function compareWorksheets(excelFile, sheet1Name, sheet2Name, sheet1Data, sheet2Data) {

            // Identify rows removed from sheet1
            const removedFromSheet1 = sheet1Data.filter(row => !sheet2Data.some(otherRow => row[0] === otherRow[0]));

            // Identify rows added to sheet2
            const addedToSheet2 = sheet2Data.filter(row => !sheet1Data.some(otherRow => row[0] === otherRow[0]));

            // Identify rows with changes in data
            const changedEntries = sheet1Data
                .filter(row => sheet2Data.some(otherRow => row[0] === otherRow[0]))
                .filter(row => {
                    const correspondingRow = sheet2Data.find(otherRow => row[0] === otherRow[0]);
                    return !Object.entries(row).every(([key, value]) => correspondingRow[key] === value);
                });

            createTable(removedFromSheet1, 'Employees only present in First Sheet', sheet1Data);

            createTable(addedToSheet2, 'Employees only present in 2nd Sheet', sheet1Data);

            printChangedEntries(changedEntries, sheet1Data, sheet2Data, sheet1Data[0]);

        }

        function printChangedEntries(changedEntries, sheet1Data, sheet2Data, headerRow) {

            const heading = document.createElement('h2');
            heading.textContent = 'Modified Employees:';
            document.body.appendChild(heading);

            changedEntries.forEach(row => {
                const correspondingRow = sheet2Data.find(otherRow => row[0] === otherRow[0]);
        
                // Find and print the differences between the two rows
                const differences = Object.entries(row).filter(([key, value]) => correspondingRow[key] !== value);
        
                const difference = `${row.slice(0, 3).join(' ')}: ${differences.map(([key, value]) => `Column: ${headerRow[key]} changed from ${sheet1Data.find(sheet1Row => sheet1Row[0] === row[0])[key]} to ${correspondingRow[key]}`).join(', ')}`;

                const heading = document.createElement('p');
                heading.textContent = difference;
                document.body.appendChild(heading);

            });
        }

        function createTable(sheetData, title, headerData) {
            const table = document.createElement('table');
            const headerRow = table.insertRow();

            // Add header cells
            headerData[0].forEach(cellData => {
                const headerCell = headerRow.insertCell();
                headerCell.textContent = cellData;
            });

            // Add data rows for sheet1
            sheetData.forEach(rowData => {
                const row = table.insertRow();
                rowData.forEach(cellData => {
                    const cell = row.insertCell();
                    cell.textContent = cellData;
                });
            });
            const heading = document.createElement('h2');
            heading.textContent = title;
            document.body.appendChild(heading);
            document.body.appendChild(table);
        }
    </script>
</body>

</html>